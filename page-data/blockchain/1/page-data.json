{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blockchain/1","result":{"pageContext":{"isCreatedByStatefulCreatePages":false,"html":"<p>거래소에서 매수, 매도 주분이 발생하고, 거래가 체결될 때, 매수 매도를 했던 유저들의 계좌에는 변화가 생깁니다.</p>\n<p>그 로직을 짜기 위해, 유저들 계좌의 잔액이 어떻게 변하는지 발생할 수 있는 상황을 4가지로 분류하여 정리해보고, 각 상황마다 유저 계좌의 변화를 공식으로 정리해보며 의사코드도 작성해보고자 합니다.</p>\n<p>아래 4가지 상황에서 오더 발생 전 유저들의 어카운트 상황은 모두 같으며, BTC의 fee는 0.0005(0.05%)입니다.<br/><br/></p>\n<h3>오더 발생 전 어카운트 상황</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">account</th>\n<th align=\"center\">balance</th>\n<th align=\"center\">locked</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">user1 eth</td>\n<td align=\"center\">400</td>\n<td align=\"center\">100</td>\n</tr>\n<tr>\n<td align=\"center\">user1 btc</td>\n<td align=\"center\">35</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">user2 eth</td>\n<td align=\"center\">300</td>\n<td align=\"center\">200</td>\n</tr>\n<tr>\n<td align=\"center\">user2 btc</td>\n<td align=\"center\">50</td>\n<td align=\"center\">2</td>\n</tr>\n</tbody>\n</table>\n<br/>\n<h2>Case 1. 매도가 먼저 있을 때.</h2>\n<p>tradeVolume = min(askOrder.volume, bidOrder.volume)<br/>\ntradePrice = askOrder.price<br/>\ndifferencePrice = bidOrder.price - tradePrice<br/>\nfee = bidOrder.unit.fee</p>\n<h2><em>1-1. 매도의 volume이 더 클 때.</em></h2>\n<ul>\n<li>1st. <em>User1</em>이 <em>ETH</em>를 <em>0.2BTC</em>에 <em>100개</em> <em>매도</em></li>\n<li>2nd. <em>User2</em>가 <em>ETH</em>를 <em>0.3BTC</em>에 <em>80개</em> <em>매수</em></li>\n</ul>\n<h3>오더 발생 후 어카운트 상황</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">account</th>\n<th align=\"center\">balance</th>\n<th align=\"center\">locked</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">user1 eth</td>\n<td align=\"center\">400 - 100 = 300</td>\n<td align=\"center\">100 + 100 = 200</td>\n</tr>\n<tr>\n<td align=\"center\">user1 btc</td>\n<td align=\"center\">35</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">user2 eth</td>\n<td align=\"center\">300</td>\n<td align=\"center\">200</td>\n</tr>\n<tr>\n<td align=\"center\">user2 btc</td>\n<td align=\"center\">50 - (24 + 0.012) = 25.988</td>\n<td align=\"center\">2 + (24 + 0.012) = 26.012</td>\n</tr>\n</tbody>\n</table>\n<p>askOrder.user.Account.askUnit.balance -= askOrder.volume<br/>\naskOrder.user.Account.askUnit.locked += askOrder.volume<br/>\nbidOrder.user.Account.bidUnit.balance -= bidOrder.volume * bidOrder.price * (1 + fee)<br/>\nbidOrder.user.Account.bidUnit.locked += bidOrder.volume * bidOrder.price * (1 + fee)</p>\n<h3>거래 체결 후 어카운트 상황</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">account</th>\n<th align=\"center\">balance</th>\n<th align=\"center\">locked</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">user1 eth</td>\n<td align=\"center\">300</td>\n<td align=\"center\">200 - 80 = 120</td>\n</tr>\n<tr>\n<td align=\"center\">user1 btc</td>\n<td align=\"center\">35 + (16 - 0.008) = 50.992</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">user2 eth</td>\n<td align=\"center\">300 + 80 = 380</td>\n<td align=\"center\">200</td>\n</tr>\n<tr>\n<td align=\"center\">user2 btc</td>\n<td align=\"center\">25.988 + (8 + 0.004) = 33.992</td>\n<td align=\"center\">26.012 - (16 + 0.008) - (8 + 0.004) = 2</td>\n</tr>\n</tbody>\n</table>\n<p>askOrder.user.Account.askUnit.locked -= tradeVolume<br/>\naskOrder.user.Account.bidUnit.balance += tradeVolume * tradePrice * (1 - fee)<br/>\nbidOrder.user.askUnit.balance += tradeVolume<br/>\nbidOrder.user.bidUnit.balance += differencePrice * tradeVolume * (1 + fee)<br/>\nbidOrder.user.bidUnit.locked -= (tradeVolume * tradePrice * (1 + fee) + differencePrice * tradeVolume * (1 + fee))</p>\n<br/>\n<h2>1-<em>2. 매수의 volume이 더 클 때.</em></h2>\n<ul>\n<li>1st. <em>User1</em>이 <em>ETH</em>를 <em>0.2BTC</em>에 <em>80개</em> <em>매도</em></li>\n<li>2nd. <em>User2</em>가 <em>ETH</em>를 <em>0.3BTC</em>에 <em>100개</em> <em>매수</em></li>\n</ul>\n<h3>오더 발생 후 어카운트 상황</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">account</th>\n<th align=\"center\">balance</th>\n<th align=\"center\">locked</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">user1 eth</td>\n<td align=\"center\">400 - 80 = 320</td>\n<td align=\"center\">100 + 80 = 180</td>\n</tr>\n<tr>\n<td align=\"center\">user1 btc</td>\n<td align=\"center\">35</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">user2 eth</td>\n<td align=\"center\">300</td>\n<td align=\"center\">200</td>\n</tr>\n<tr>\n<td align=\"center\">user2 btc</td>\n<td align=\"center\">50 - (30 + 0.015) = 19.985</td>\n<td align=\"center\">2 + (30 + 0.015) = 32.015</td>\n</tr>\n</tbody>\n</table>\n<p>askOrder.user.Account.askUnit.balance -= askOrder.volume<br/>\naskOrder.user.Account.askUnit.locked += askOrder.volume<br/>\nbidOrder.user.Account.bidUnit.balance -= bidOrder.volume * bidOrder.price * (1 + fee)<br/>\nbidOrder.user.Account.bidUnit.locked += bidOrder.volume * bidOrder.price * (1 + fee)</p>\n<h3>거래 체결 후 어카운트 상황</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">account</th>\n<th align=\"center\">balance</th>\n<th align=\"center\">locked</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">user1 eth</td>\n<td align=\"center\">320</td>\n<td align=\"center\">180 - 80 = 100</td>\n</tr>\n<tr>\n<td align=\"center\">user1 btc</td>\n<td align=\"center\">35 + (16 - 0.008) = 50.992</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">user2 eth</td>\n<td align=\"center\">300 + 80 = 380</td>\n<td align=\"center\">200</td>\n</tr>\n<tr>\n<td align=\"center\">user2 btc</td>\n<td align=\"center\">19.985 + (8 + 0.004) = 27.989</td>\n<td align=\"center\">32.015 - (16 + 0.008) - (8 + 0.004) = 8.003</td>\n</tr>\n</tbody>\n</table>\n<p>askOrder.user.Account.askUnit.locked -= tradeVolume<br/>\naskOrder.user.Account.bidUnit.balance += tradeVolume * tradePrice * (1 - fee)<br/>\nbidOrder.user.askUnit.balance += tradeVolume<br/>\nbidOrder.user.bidUnit.balance += differencePrice * tradeVolume * (1 + fee)<br/>\nbidOrder.user.bidUnit.locked -= (tradeVolume * tradePrice * (1 + fee) + differencePrice * tradeVolume * (1 + fee))\n<br/><br/></p>\n<h2>Case 2. 매수가 먼저 있을 때.</h2>\n<p>tradeVolume = min(askOrder.volume, bidOrder.volume)<br/>\ntradePrice = bidOrder.price<br/>\ndifferencePrice = askOrder.price - tradePrice<br/>\nfee = bidOrder.unit.fee</p>\n<h2>2-1<em>. 매수의 volume이 더 클 때.</em></h2>\n<ul>\n<li>1st. <em>User1</em>이 <em>ETH</em>를 <em>0.3BTC</em>에 <em>100개</em> <em>매수</em></li>\n<li>2nd. <em>User2</em>가 <em>ETH</em>를 <em>0.2BTC</em>에 <em>80개</em> <em>매도</em></li>\n</ul>\n<h3>오더 발생 후 어카운트 상황</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">account</th>\n<th align=\"center\">balance</th>\n<th align=\"center\">locked</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">user1 eth</td>\n<td align=\"center\">400</td>\n<td align=\"center\">100</td>\n</tr>\n<tr>\n<td align=\"center\">user1 btc</td>\n<td align=\"center\">35 - (30 + 0.015) = 4.985</td>\n<td align=\"center\">3 + (30 + 0.015) = 33.015</td>\n</tr>\n<tr>\n<td align=\"center\">user2 eth</td>\n<td align=\"center\">300 - 80 = 220</td>\n<td align=\"center\">200 + 80 = 280</td>\n</tr>\n<tr>\n<td align=\"center\">user2 btc</td>\n<td align=\"center\">50</td>\n<td align=\"center\">2</td>\n</tr>\n</tbody>\n</table>\n<p>bidOrder.user.Account.bidUnit.balance -= bidOrder.volume * tradePrice * (1 + fee)<br/>\nbidOrder.user.Account.bidUnit.locked += bidOrder.volume * tradePrice * (1 + fee)<br/>\naskOrder.user.Account.askUnit.balance -= askOrder.volume<br/>\naskOrder.user.Account.askUnit.locked += askOrder.volume</p>\n<h3>거래 체결 후 어카운트 상황</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">account</th>\n<th align=\"center\">balance</th>\n<th align=\"center\">locked</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">user1 eth</td>\n<td align=\"center\">400 + 80 = 480</td>\n<td align=\"center\">100</td>\n</tr>\n<tr>\n<td align=\"center\">user1 btc</td>\n<td align=\"center\">4.985</td>\n<td align=\"center\">33.015 - (24 + 0.012) = 9.003</td>\n</tr>\n<tr>\n<td align=\"center\">user2 eth</td>\n<td align=\"center\">220</td>\n<td align=\"center\">280 - 80 = 200</td>\n</tr>\n<tr>\n<td align=\"center\">user2 btc</td>\n<td align=\"center\">50 + (24 - 0.012) = 73.988</td>\n<td align=\"center\">2</td>\n</tr>\n</tbody>\n</table>\n<p>bidOrder.user.askUnit.balance += tradeVolume<br/>\nbidOrder.user.bidUnit.locked -= tradeVolume * tradePrice * (1 + fee)<br/>\naskOrder.user.Account.askUnit.locked -= tradeVolume<br/>\naskOrder.user.Account.bidUnit.balance += tradeVolume * tradePrice * (1 - fee)</p>\n<br/>\n<h2>2-2<em>. 매도의 volume이 더 클 때.</em></h2>\n<ul>\n<li>1st. <em>User1</em>이 <em>ETH</em>를 <em>0.3BTC</em>에 <em>80개</em> <em>매수</em></li>\n<li>2nd. <em>User2</em>가 <em>ETH</em>를 <em>0.2BTC</em>에 <em>100개</em> <em>매도</em></li>\n</ul>\n<h3>오더 발생 후 어카운트 상황</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">account</th>\n<th align=\"center\">balance</th>\n<th align=\"center\">locked</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">user1 eth</td>\n<td align=\"center\">400</td>\n<td align=\"center\">100</td>\n</tr>\n<tr>\n<td align=\"center\">user1 btc</td>\n<td align=\"center\">35 - (24 + 0.012) = 10.988</td>\n<td align=\"center\">3 + (24 + 0.012) = 27.012</td>\n</tr>\n<tr>\n<td align=\"center\">user2 eth</td>\n<td align=\"center\">300 - 100 = 200</td>\n<td align=\"center\">200 + 100 = 300</td>\n</tr>\n<tr>\n<td align=\"center\">user2 btc</td>\n<td align=\"center\">50</td>\n<td align=\"center\">2</td>\n</tr>\n</tbody>\n</table>\n<p>bidOrder.user.Account.bidUnit.balance -= bidOrder.volume * tradePrice * (1 + fee)<br/>\nbidOrder.user.Account.bidUnit.locked += bidOrder.volume * tradePrice * (1 + fee)<br/>\naskOrder.user.Account.askUnit.balance -= askOrder.volume<br/>\naskOrder.user.Account.askUnit.locked += askOrder.volume</p>\n<h3>거래 체결 후 어카운트 상황</h3>\n<table>\n<thead>\n<tr>\n<th align=\"center\">account</th>\n<th align=\"center\">balance</th>\n<th align=\"center\">locked</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">user1 eth</td>\n<td align=\"center\">400 + 80 = 480</td>\n<td align=\"center\">100</td>\n</tr>\n<tr>\n<td align=\"center\">user1 btc</td>\n<td align=\"center\">10.988</td>\n<td align=\"center\">27.012 - (24 + 0.012) = 3</td>\n</tr>\n<tr>\n<td align=\"center\">user2 eth</td>\n<td align=\"center\">200</td>\n<td align=\"center\">300 - 80 = 220</td>\n</tr>\n<tr>\n<td align=\"center\">user2 btc</td>\n<td align=\"center\">50 + (24 - 0.012) = 73.988</td>\n<td align=\"center\">2</td>\n</tr>\n</tbody>\n</table>\n<p>bidOrder.user.askUnit.balance += tradeVolume<br/>\nbidOrder.user.bidUnit.locked -= tradeVolume * tradePrice * (1 + fee)<br/>\naskOrder.user.Account.askUnit.locked -= tradeVolume<br/>\naskOrder.user.Account.bidUnit.balance += tradeVolume * tradePrice * (1 - fee)</p>\n<br/>\n<h2>결론</h2>\n<p>같은 거래들이 체결되더라도 어떤 거래가 먼저 발생했는 지에 따라 거래 가격, 거래량 등이 달라지기 때문에, 개념을 정확히 이해하는 데 시간이 좀 걸렸습니다.</p>\n<p>의사코드를 정리해 보니, 다음과 같은 결과가 나옵니다.</p>\n<ul>\n<li>오더 발생 후의 로직은 모두 동일하다.</li>\n<li>거래 체결 후의 로직은 Case1과 Case2만 구분해 주면 된다.</li>\n</ul>","title":"거래소 거래 체결, 잔액 처리에 대한 상황 및 로직 정리","date":"2019-11-24 11:05:00","excerpt":"거래소에서 매수, 매도 주분이 발생하고, 거래가 체결될 때, 매수 매도를 했던 유저들의 계좌에는 변화가 생깁니다. 그 로직을 짜기 위해, 유저들 계좌의 잔액이 어떻게 변하는지 발생할 수 있는 상황을 4가지로 분류하여 정리해보고, 각 상황마다 유저 계좌의 변화를 공식으로 정리해보며 의사코드도 작성해보고자 합니다. 아래 4가지 상황에서 오더 발생 전 유저들의…"}}}