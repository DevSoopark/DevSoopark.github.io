---
title: Server Side Rendering과 Store Injection
category: devlog
subCategory: react
path: /react/2
date: 2019-08-12 14:29:00
---

> zeit 에서 만들어 논 next 예제나 다른 몇몇 예제들을 보면 getInitialProps() 에서 store를 주입하고 있습니다.

## getInitialProps 란?

next.js에서는 getInitialProps라는 정적 함수를 이용해서 page component로 속성값을 전달합니다. 각 page의 getInitialProps 함수는 page 진입 직전에 호출되는 것으로, LifeCycle 제일 처음에 위치하고 있다고 생각하면 될 것 같습니다. 또한, getInitialProps 함수는 사용자가 첫 페이지를 요청하면 서버에서, 이후에는 클라이언트에서 호출됩니다.

## store 주입은 getInitialProps에서?

zeit 에서 만들어 논 next 예제나 다른 몇몇 예제들을 보면 getInitialProps에서 store를 주입하고 있었고, store 주입을 getInitialProps에서 하는 것과 CSR 할 때처럼 root component에서 하는 게 뭐가 다른지에 대한 의문이 있었습니다.

그리고 알아본 결과, "같은 것 같은데요?" 라고 말씀 드리고 싶습니다. 정확하게는, store 주입을 getInitialProps에서 하든, root component에서 하든 문제 될 게 없다는 것입니다.

## 나, SSR인데, 너, 서버냐?

그렇다면, 왜 store 주입을 getInitialProps에서 할까요?

getInitialProps에서 store 주입을 하는 코드를 보면 서버인지 아닌지 판단해서 서버면 store를 초기화 시키고, 클라이언트면 왔던 store 그대로 반환해줍니다.

다음은 제가 서버인지 아닌지 판단해야 하는 이유에 대해 2가지 가설을 세워본 것입니다.

1. 서버에서 모든 스토어를 초기화시키는 게 아니라 서버에서도 유지시켜줘야 되는 데이터가 있는건가?

   서버 캐싱을 말하는 게 아니라, 예를 들면, 사용자가 처음에 url을 입력해서 들어가고(서버에서 getInitialProps 접근), 이후에 페이지 이동을 하다가(클라이언트에서 getInitialProps 접근), 다시 url을 입력해서 페이지를 이동하는 경우(서버에서 getInitialProps 접근)에도 store를 유지시켜줘야 하는가 에 대해 생각해봤습니다.

2. CSR에서는 클라이언트 사이드에서 ajax를 이용해서 서버와 통신을 했었는데(componentdidmount 등을 이용해서 http request를 보냈었는데), SSR 할 때는 서버 사이드에서 렌더링 할 때, 서버에서 http 통신을 통해 데이터를 받아오는 경우가 있는 건가?

1번의 이유는 틀렸고, 2번의 이유는 정답이었습니다.

다음은 오픈카톡방에서 두 명의 개발자와 나눈 대화입니다.

    Q:
    혹시 next를 redux나 mobx 랑 사용하시는 분들 중에 store 주입을 루트 컴포넌트에서 하는게 아니라,
    _app에 getInitialProps() 커스터마이징해서 하는 이유가 뭔지 아시는 분 계신가요?
    zeit에서 만든 next 예제나 다른 몇몇 예제들 봐도 서버인지 클라인지 판단해서
    서버면 store를 초기화시켜주고, 클라면 store를 유지시켜주는거 같은데..

    SSR 안하고 CSR 할때처럼 리액트 코드단에서 store를 주입해 뒀으면
    DOM Tree를 생성할 때 알아서 필요한 돔은 store를 갖고 있을 거고,
    그걸 서버에서 건드리지 않으면 결국 클라에서 라우팅하든 서버에서 라우팅하든 상관없이
    어차피 클라에서는 스토어 유지되는 거고 서버도 손을 안댔으니까 괜찮은거 아닌가요?

    A1:
    서버에서 store를 만드는 이유가 초기 로딩때 필요한 데이터를 가져오기 위해서 아니었나요?
    제가 next는 아니고 express 이용해서 ssr을 구현해서,
    저는 서버에서는 store 생성해서 초기 로딩에 필요한 데이터를 가져와서 스토어에 저장 후
    이 데이터를 클라에 보낼때 스토어에서 뽑아서 window 객체를 통해서 넘기고, 클라에서 받아서 저장합니다.

    A2:
    왜 클라 서버에 각각 구분을 두느냐 이게 질문이라면, 자료 주입이 실제로는 두번 일어날 수 있거든요.
    왜냐면, 서버에서 렌더링된 자료를 내리기 전에
    1) 미리 리덕스에서 디스패치하고 그 이후에 스테이터스를 가지고
    2) 완성된 스토어를 다시 클라이언트로 뿌려줘야 되거든요.
    이렇게 애햐 클라쪽에서 리퀘스트를 다시 안날려도 되는거죠.
    만약 디스패치가 클라이언트에서밖에 일어나지 않는다면 ssr의 의미가 많이 퇴색되어 버려요.
    결국에는 껍데기만 있는 html에 중요한 작업은 모두 클라이언트에서 일어나니 spa랑 다른 게 없거든요.

    Q:
    네, 질문의 요점은 왜 서버에서 store를 초기화시켜줘야 되는가 였습니다.
    결국 ssr 할 때 서버에서 store 초기화를 시키는 이유가 A1님이 말씀하신것처럼
    서버사이드에서 렌더링할때 필요한 데이터들을 hydrate 해야되서인지,
    그리고 그것만이 이유인지가 궁금했습니다.

    A2:
    네, 예를 들면, 목록을 가져오는 건 클라가 요청을 했을 때 새로 일어나면 안돼서,
    최초 렌더링시에는 서버에서 똑같은 액션을 가지고 자료를 미리 가져와서 그 결과만 주면 된다는 거죠.
    완전 텅 빈 스토어만 주고 클라가 알아서 정보를 가져오라고 하면 결국에는 spa니까요.

    A1:
    A2님, SSR이 퇴색된다는건 공감하지만, spa 이라는 단어보다 CSR 이 맞을 것 같습니다.

    A2:
    지적 감사합니다ㅎㅎ

## 정리

결국 next.js 에서 store 주입을 getInitialProps에서 하는 이유는 다음과 같습니다.

데이터 의존성이 높은 페이지의 경우 서버사이드에서 렌더링할때 데이터도 같이 렌더링해줘야하니까, root component에서 (next의 경우 \_app에서) 서버인지 클라인지 판단해서, 클라면 왔던 스토어 그대로 반환해주고, 서버면 다시 스토어 초기화(필요한 데이터들은 채우고)해서 반환해줘야 할 필요가 있다는 것입니다.

물론, 모든 데이터를 서버사이드에서 다 렌더링해서 클라이언트로 보낼 필요는 없을 것입니다. 서버에 부하가 심해질 것이기 때문이죠.

그래서 개발자 판단 하에 서버사이드에서 렌더링할 데이터만 getInitialProps에서 초기화를 시키고,
component에서 해당 데이터를 렌더링하는 부분은 and 연산자나 삼항 연산자로
데이터가 있을 때만 렌더링되게 하면 될 것 같습니다.
